<!DOCTYPE html>
<html class="light" lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Keşiş Kafe - Raporlar</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#4CAF50",
              "primary-light": "#E8F5E9",
              "primary-dark": "#2E7D32",
              "background-light": "#F9F9F7",
              "background-dark": "#1C1C1E",
              "surface-light": "#FFFFFF",
              "surface-dark": "#2C2C2E",
              "text-main": "#2F3E2F",
              "text-secondary": "#5C6B5C",
            },
            fontFamily: {
              display: ["Work Sans", "sans-serif"],
              body: ["Work Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Work Sans", sans-serif;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #e0e0e0;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #bdbdbd;
      }

      /* Embedded (iframe içi) görünümde dış layout'u gizle */
      body.embedded-report {
        background: transparent;
        overflow: auto;
        height: auto;
      }
      body.embedded-report #sidebar-container {
        display: none;
      }
      body.embedded-report main {
        padding: 0;
        border: none;
      }
    </style>
  </head>
  <body
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-gray-200 antialiased h-screen flex flex-col overflow-hidden"
  >
    <div class="flex h-screen overflow-hidden">
      <div id="sidebar-container"></div>
      <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
          <div class="max-w-7xl mx-auto flex flex-col gap-6">
            
            <!-- Filter Header -->
             <div class="flex flex-col md:flex-row gap-4 items-center justify-between bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800">
                  <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
                    <div class="relative w-full sm:w-72">
                      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-primary font-medium">person_search</span>
                      <select id="employeeSelect" class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm focus:ring-primary focus:border-primary font-medium text-text-main dark:text-white shadow-sm">
                        <option>Yükleniyor...</option>
                      </select>
                    </div>
                    <div class="h-8 w-px bg-gray-200 dark:bg-gray-700 hidden sm:block"></div>
                    <div class="relative w-full sm:w-auto">
                      <input 
                        type="month" 
                        id="reportPeriod"
                        class="w-full sm:w-auto px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm text-text-main dark:text-white focus:ring-primary focus:border-primary"
                      />
                    </div>
                  </div>
                  <div class="flex gap-3 w-full md:w-auto">
                    <button id="downloadReportBtn" onclick="downloadReport()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors text-sm font-medium shadow-sm shadow-primary/30">
                      <span class="material-symbols-outlined text-[20px]">download</span>
                      Raporu İndir
                    </button>
                  </div>
             </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
              <div
                class="lg:col-span-1 bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col items-center text-center h-full relative overflow-hidden group"
              >
                <div
                  class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-primary/10 to-transparent"
                ></div>
                <div
                  class="relative z-10 size-24 rounded-full bg-white dark:bg-surface-dark p-1 shadow-md mb-3"
                >
                  <div
                    class="size-full rounded-full bg-purple-100 text-purple-600 border border-purple-200 flex items-center justify-center text-2xl font-bold"
                  >
                    <span id="employeeInitials">ZK</span>
                  </div>
                </div>
                <h2
                  id="employeeName"
                  class="relative z-10 text-xl font-bold text-text-main dark:text-white"
                >
                  Zeynep Kaya
                </h2>
                <div class="relative z-10 flex items-center gap-2 mb-6 mt-1">
                  <span
                    id="employeePosition"
                    class="text-sm text-text-secondary"
                    >Kıdemli Barista</span
                  >
                  <span class="size-1.5 rounded-full bg-gray-300"></span>
                  <span
                    id="employeeStatus"
                    class="text-xs font-semibold px-2 py-0.5 bg-green-100 text-green-700 rounded-full border border-green-200"
                    >Aktif</span
                  >
                </div>
                <div class="relative z-10 w-full flex flex-col gap-3 mb-6">
                  <div
                    class="flex justify-between items-center text-sm p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-800"
                  >
                    <span class="text-text-secondary flex items-center gap-2"
                      ><span class="material-symbols-outlined text-[16px]"
                        >calendar_today</span
                      >Başlangıç</span
                    >
                    <span
                      id="employeeStartDate"
                      class="font-medium text-text-main dark:text-white"
                      >12.01.2021</span
                    >
                  </div>
                  <!-- Hourly rate removed -->
                </div>
                <!-- Edit button removed -->
              </div>
              <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div
                  class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col justify-between hover:shadow-md transition-shadow"
                >
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-text-secondary text-sm font-medium">
                        Toplam Çalışma
                      </p>
                      <h3
                        id="totalWorkTime"
                        class="text-3xl font-bold text-text-main dark:text-white mt-2"
                      >
                        168
                        <span class="text-lg font-normal text-text-secondary"
                          >Saat</span
                        >
                      </h3>
                    </div>
                    <div
                      class="p-2.5 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-blue-600 border border-blue-100 dark:border-blue-800"
                    >
                      <span class="material-symbols-outlined">schedule</span>
                    </div>
                  </div>
                  <div
                    class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800"
                  >
                    <div
                      class="flex justify-between text-xs text-text-secondary mb-1.5"
                    >
                      <span id="monthlyTargetText">Aylık Hedef: 160s</span>
                      <span
                        id="overtimeSummary"
                        class="text-green-600 font-semibold"
                        >+8s Fazla Mesai</span
                      >
                    </div>
                    <div
                      class="w-full bg-gray-100 dark:bg-gray-700 h-2 rounded-full overflow-hidden"
                    >
                      <div
                        class="bg-blue-500 h-full rounded-full"
                        style="width: 100%"
                      ></div>
                    </div>
                  </div>
                </div>
                <div
                  class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col justify-between hover:shadow-md transition-shadow"
                >
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-text-secondary text-sm font-medium">
                        Tahmini Hak Ediş (Brüt)
                      </p>
                      <h3
                        id="employeeGross"
                        class="text-3xl font-bold text-text-main dark:text-white mt-2"
                      >
                        ₺0.00
                      </h3>
                    </div>
                    <div
                      class="p-2.5 bg-green-50 dark:bg-green-900/20 rounded-xl text-green-600 border border-green-100 dark:border-green-800"
                    >
                      <span class="material-symbols-outlined">payments</span>
                    </div>
                  </div>
                  <div
                    class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800 flex flex-col gap-1.5"
                  >
                    <div class="flex justify-between text-xs items-center">
                      <span class="text-text-secondary">Normal Hak Ediş:</span>
                      <span
                        id="normalGross"
                        class="font-medium text-text-main dark:text-white"
                        >₺0.00</span
                      >
                    </div>
                    <div class="flex justify-between text-xs items-center">
                      <span class="text-text-secondary flex items-center gap-1"
                        ><span
                          class="size-1.5 rounded-full bg-orange-500"
                        ></span
                        ><span id="overtimeLabel">Mesai Ücreti:</span></span
                      >
                      <span
                        id="overtimeGross"
                        class="font-medium text-text-main dark:text-white"
                        >₺0.00</span
                      >
                    </div>
                  </div>
                </div>

                <div
                  class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col justify-between hover:shadow-md transition-shadow"
                >
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-text-secondary text-sm font-medium">
                        Kalan Yıllık İzin
                      </p>
                      <h3
                        id="employeeLeave"
                        class="text-3xl font-bold text-text-main dark:text-white mt-2"
                      >
                        12 Gün
                      </h3>
                    </div>
                    <div
                      class="p-2.5 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-blue-600 border border-blue-100 dark:border-blue-800"
                    >
                      <span class="material-symbols-outlined"
                        >beach_access</span
                      >
                    </div>
                  </div>
                </div>

                <div
                  class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col justify-between hover:shadow-md transition-shadow"
                >
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-text-secondary text-sm font-medium">
                        Geç Kalma (Bu Ay)
                      </p>
                      <h3
                        id="employeeLateCount"
                        class="text-3xl font-bold text-text-main dark:text-white mt-2"
                      >
                        0
                      </h3>
                    </div>
                    <div
                      class="p-2.5 bg-red-50 dark:bg-red-900/20 rounded-xl text-red-600 border border-red-100 dark:border-red-800"
                    >
                      <span class="material-symbols-outlined"
                        >running_with_errors</span
                      >
                    </div>
                  </div>
                  <div
                     class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800"
                  >
                     <span class="text-xs text-text-secondary">Tolerans: 15dk</span>
                  </div>
                </div>

                <div
                  class="col-span-1 sm:col-span-2 bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm mt-2"
                >
                  <div class="flex items-center justify-between mb-6">
                    <h4
                      class="text-base font-bold text-text-main dark:text-white flex items-center gap-2"
                    >
                      <span class="material-symbols-outlined text-gray-400"
                        >bar_chart</span
                      >
                      Günlük Çalışma
                    </h4>
                    <div class="flex gap-2">
                      <span
                        class="flex items-center gap-1 text-xs text-text-secondary"
                        ><span class="size-2 rounded-full bg-primary"></span>
                        Normal</span
                      >
                      <span
                        class="flex items-center gap-1 text-xs text-text-secondary"
                        ><span class="size-2 rounded-full bg-orange-400"></span>
                        Mesai</span
                      >
                    </div>
                  </div>
                  <div
                    id="dailyWorkChart"
                    class="h-48 flex items-end justify-between gap-2 w-full pt-4 relative"
                  >
                    <div
                      id="dailyWorkChartGrid"
                      class="absolute inset-0 flex flex-col justify-between pointer-events-none pb-6 pl-0 pr-0"
                    >
                      <div
                        class="w-full h-px bg-gray-100 dark:bg-gray-800 border-dashed"
                      ></div>
                      <div
                        class="w-full h-px bg-gray-100 dark:bg-gray-800 border-dashed"
                      ></div>
                      <div
                        class="w-full h-px bg-gray-100 dark:bg-gray-800 border-dashed"
                      ></div>
                    </div>
                    <!-- Bars will be injected here -->
                  </div>
                  <div
                    id="dailyWorkLabels"
                    class="flex justify-between text-[10px] text-gray-400 mt-2 px-1"
                  ></div>
                    <!-- Dynamic -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script src="/components/toast.js"></script>
    <script src="/components/sidebar.js"></script>
    <script>
      // Yetki kontrolü
      (function guardAdmin() {
        const userType = localStorage.getItem("userType");
        if (!userType) {
          window.location.href = "/";
          return;
        }
        if (userType === "kasa") {
          window.location.href = "/cashier";
        }
      })();

      const monthNames = [
        "Ocak",
        "Şubat",
        "Mart",
        "Nisan",
        "Mayıs",
        "Haziran",
        "Temmuz",
        "Ağustos",
        "Eylül",
        "Ekim",
        "Kasım",
        "Aralık",
      ];

      let selectedEmployeeId = null;
      let currentStartDate = null;
      let currentEndDate = null;

      function getCurrentMonthRange() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const first = new Date(year, month, 1);
        const last = new Date(year, month + 1, 0);
        return {
          start: first.toISOString().slice(0, 10),
          end: last.toISOString().slice(0, 10),
          label: `${monthNames[month]} ${year}`,
        };
      }

      async function loadEmployees() {
        try {
          const res = await fetch("/api/employees");
          if (!res.ok) throw new Error("Çalışan listesi alınamadı");
          const data = await res.json();

          const select = document.getElementById("employeeSelect");
          if (!select) return;
          select.innerHTML = "";

          if (!data.length) {
            const opt = document.createElement("option");
            opt.textContent = "Personel bulunamadı";
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            return;
          }

          data.forEach((emp, index) => {
            const opt = document.createElement("option");
            opt.value = emp.id;
            opt.textContent = `${emp.name} ${emp.surname} (${
              emp.position_name || "Pozisyon yok"
            })`;
            if (index === 0) {
              opt.selected = true;
              selectedEmployeeId = emp.id;
              updateEmployeeHeader(emp);
              // İlk (seçili) personel için izin bilgilerini yükle
              loadEmployeeLeave(selectedEmployeeId);
            }
            select.appendChild(opt);
          });

          select.addEventListener("change", (e) => {
            const id = parseInt(e.target.value, 10);
            const emp = data.find((x) => x.id === id);
            selectedEmployeeId = id;
            if (emp) {
              updateEmployeeHeader(emp);
            }
            loadSalaryForEmployee();
            // Seçili personel için küçük günlük çalışma grafiğini yenile
            loadEmployeeDailyHours(selectedEmployeeId);
            // Seçili personel için yıllık izin bilgisini yükle
            loadEmployeeLeave(selectedEmployeeId);
          });
        } catch (err) {
          console.error(err);
          if (window.toast) {
            toast.error("Personel listesi yüklenirken hata oluştu");
          }
        }
      }

      function updateEmployeeHeader(emp) {
        const initials =
          (emp.name?.[0] || "").toUpperCase() +
          (emp.surname?.[0] || "").toUpperCase();
        const statusText = "Aktif";

        const initialsEl = document.getElementById("employeeInitials");
        const nameEl = document.getElementById("employeeName");
        const posEl = document.getElementById("employeePosition");
        const statusEl = document.getElementById("employeeStatus");
        const startEl = document.getElementById("employeeStartDate");

        if (initialsEl) initialsEl.textContent = initials || "??";
        if (nameEl) nameEl.textContent = `${emp.name} ${emp.surname}`;
        if (posEl) posEl.textContent = emp.position_name || "Pozisyon Yok";
        if (statusEl) statusEl.textContent = statusText;
        if (startEl && emp.created_at) {
          const d = new Date(emp.created_at);
          startEl.textContent = d.toLocaleDateString("tr-TR");
        }
      }

      async function loadSalaryForEmployee() {
        if (!selectedEmployeeId) return;
        try {
          const res = await fetch(
            `/api/salary/calculate?startDate=${currentStartDate}&endDate=${currentEndDate}`
          );
          if (!res.ok) throw new Error("Maaş verisi alınamadı");
          const data = await res.json();
          const empData = data.find((x) => x.id === selectedEmployeeId);

          // Bu dönemde bu personel için veri yoksa sıfırla
          if (!empData) {
            const totalWorkEl = document.getElementById("totalWorkTime");
            if (totalWorkEl) totalWorkEl.textContent = `0s 0dk`;
            const grossEl = document.getElementById("employeeGross");
            if (grossEl) grossEl.textContent = `₺0.00`;
            const normalEl = document.getElementById("normalGross");
            if (normalEl) normalEl.textContent = `₺0.00`;
            const overtimeEl = document.getElementById("overtimeGross");
            if (overtimeEl) overtimeEl.textContent = `₺0.00`;
            const hourlyEl = document.getElementById("employeeHourlyRate");
            if (hourlyEl) hourlyEl.textContent = `₺0.00`;

            loadEmployeeDailyHours(selectedEmployeeId);
            // İzin bilgisini de yenile
            loadEmployeeLeave(selectedEmployeeId);
            return;
          }

          const totalHours = empData.hours + empData.minutes / 60;
          const targetHours = parseFloat(empData.baseHours) > 0 ? parseFloat(empData.baseHours) : 0; // Gerçek planı kullan
          const overtimePay = parseFloat(empData.overtimePay) || 0;
          const normalGross = parseFloat(empData.normalPay) || 0;

          const totalWorkEl = document.getElementById("totalWorkTime");
          const monthlyTargetEl = document.getElementById("monthlyTargetText");
          const overtimeSummaryEl = document.getElementById("overtimeSummary");
          const hourlyEl = document.getElementById("employeeHourlyRate");

          if (totalWorkEl) {
            const actualMinutes = empData.actualMinutes || 0;
            const h = Math.floor(actualMinutes / 60);
            const m = actualMinutes % 60;
            totalWorkEl.textContent = `${h}s ${m}dk`;
          }
          if (monthlyTargetEl) {
            monthlyTargetEl.textContent = targetHours > 0 ? `Hedef: ${targetHours}s` : `Plan Yok`;
          }
          if (overtimeSummaryEl) {
              const otAmount = parseFloat(empData.overtimePay);
              if (otAmount > 0) {
                 overtimeSummaryEl.textContent = `${empData.overtimeDisplay || 'Fazla Mesai'}`;
                 overtimeSummaryEl.className = "text-green-600 font-semibold";
              } else {
                 overtimeSummaryEl.textContent = "Normal Çalışma";
                 overtimeSummaryEl.className = "text-text-secondary font-medium";
              }
          }
          if (hourlyEl) {
             const rate = parseFloat(empData.hourlyRate) || 0;
             hourlyEl.textContent = `₺${rate.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
          }

          const grossEl = document.getElementById("employeeGross");
          if (grossEl) {
            grossEl.textContent = `₺${parseFloat(
              empData.grossSalary
            ).toLocaleString("tr-TR", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}`;
          }

          const normalEl = document.getElementById("normalGross");
          if (normalEl) normalEl.textContent = `₺${normalGross.toLocaleString("tr-TR", {minimumFractionDigits: 2})}`;
          const overtimeEl = document.getElementById("overtimeGross");
          if (overtimeEl)
            overtimeEl.textContent = `₺${overtimePay.toLocaleString("tr-TR", {minimumFractionDigits: 2})}`;

          const overtimeLabel = document.getElementById("overtimeLabel");
          if (overtimeLabel) {
              const mult = empData.overtimeMultiplier || 1.5;
              overtimeLabel.textContent = `Mesai (x${mult}):`;
          }

          // Seçili personel için günlük grafiği güncelle
          loadEmployeeDailyHours(selectedEmployeeId);

          // İzin bilgisini yenile
          loadEmployeeLeave(selectedEmployeeId);
        } catch (err) {
          console.error(err);
          if (window.toast) {
            toast.error("Personel maaş verisi yüklenirken hata oluştu");
          }
        }
      }

      // Yardımcı: Saniyeleri okunabilir metne çevir
      function formatSecondsToLabel(sec) {
        const hours = Math.floor(sec / 3600);
        const minutes = Math.floor((sec % 3600) / 60);
        return `${hours}s ${minutes}dk`;
      }

      // Seçili dönem için günlük çalışma saatlerini yükle
      async function loadEmployeeDailyHours(empId) {
        const chart = document.getElementById("dailyWorkChart");
        const labels = document.getElementById("dailyWorkLabels");
        if (!chart || !labels || !empId) return;

        // Mevcut barları temizle
        chart.querySelectorAll(".dynamic-bar").forEach((n) => n.remove());
        labels.innerHTML = "";

        if(!currentStartDate || !currentEndDate) return;
        
        // Aralık için logları getir
        let logs = [];
        let lateCount = 0;
        try {
            const res = await fetch(`/api/employees/${empId}/logs?startDate=${currentStartDate}&endDate=${currentEndDate}`);
            if(res.ok) {
                logs = await res.json();
                
                // Geç kalmaları say
                lateCount = logs.filter(l => l.is_late === 1).length;
            }
        } catch(e) {
            console.error("Fetch logs error", e);
        }
        
        // Geç Kalma KPI Güncelle
        const lateEl = document.getElementById("employeeLateCount");
        if(lateEl) {
            lateEl.textContent = lateCount; 
            if(lateCount > 0) lateEl.classList.add('text-red-500');
            else lateEl.classList.remove('text-red-500');
        }

        // Tarih kovalarını oluştur
        const start = new Date(currentStartDate);
        const end = new Date(currentEndDate);
        const daysArg = [];
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            daysArg.push(new Date(d));
        }

        // Grafiği Sıfırla (Izgarayı Koru)
        chart.innerHTML = `
           <div id="dailyWorkChartGrid" class="absolute inset-0 flex flex-col justify-between pointer-events-none pb-6 pl-0 pr-0">
             <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-dashed"></div>
             <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-dashed"></div>
             <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-dashed"></div>
           </div>
        `;

        // Günlük saatleri hesapla (Global Sıralama)
        // 1. Tüm logları sırala
        logs.sort((a,b) => new Date(a.log_time) - new Date(b.log_time));
        
        // 2. İterasyon yap ve tarihlere topla
        const dayHoursMap = {}; // "YYYY-MM-DD" -> hours
        let currentCheckIn = null;

        logs.forEach(log => {
             if (log.type === 1) {
                 currentCheckIn = new Date(log.log_time);
             } else if (log.type === 2 && currentCheckIn) {
                 const checkOut = new Date(log.log_time);
                 const durationSec = (checkOut - currentCheckIn) / 1000;
                 
                 // Giriş Tarihine Ata
                 const dateStr = currentCheckIn.toISOString().slice(0, 10);
                 dayHoursMap[dateStr] = (dayHoursMap[dateStr] || 0) + (durationSec / 3600);
                 
                 currentCheckIn = null;
             }
        });

        const hoursArr = daysArg.map(d => {
            const ds = d.toISOString().slice(0, 10);
            return dayHoursMap[ds] || 0;
        });

        const maxH = Math.max(...hoursArr, 10); 

        if (hoursArr.every((h) => h === 0)) {
           chart.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-sm text-gray-400">Veri bulunamadı</div>';
        } else {
             // Barları render et
            daysArg.forEach((d, idx) => {
              const hour = hoursArr[idx] || 0;
              const pct = Math.min((hour / maxH) * 100, 100);
    
              const wrap = document.createElement("div");
              wrap.className = "dynamic-bar flex-1 h-full flex items-end group/bar hover:bg-gray-50/50 transition-colors rounded-sm relative";
              // Barlara basit z-index ekle, böylece ızgaranın üzerinde olsunlar
              wrap.style.zIndex = "10";
    
              const inner = document.createElement("div");
              inner.className = "w-full mx-[1px] relative flex flex-col justify-end h-full";
              
              const bar = document.createElement("div");
              bar.className = `w-full rounded-t-sm transition-all ${hour > 8 ? 'bg-orange-400' : 'bg-primary'}`;
              bar.style.height = `${pct}%`;
              
              inner.appendChild(bar);
    
              const tooltip = document.createElement("div");
              tooltip.className =
                "absolute bottom-full left-1/2 -translate-x-1/2 mb-1 text-[10px] bg-gray-800 text-white px-2 py-1 rounded opacity-0 group-hover/bar:opacity-100 transition-opacity whitespace-nowrap z-20 pointer-events-none";
              tooltip.textContent = `${d.toLocaleDateString('tr-TR', {day:'numeric', month:'short'})}: ${formatSecondsToLabel(Math.round(hour * 3600))}`;
              inner.appendChild(tooltip);
    
              wrap.appendChild(inner);
              chart.appendChild(wrap);
            });
        }
        
        // Dinamik Etiketler (Başlangıç - Orta - Bitiş)
        labels.innerHTML = "";
        const labelDates = [daysArg[0], daysArg[Math.floor(daysArg.length/2)], daysArg[daysArg.length-1]];
        labelDates.forEach(d => {
             const sp = document.createElement('span');
             sp.textContent = d.toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
             labels.appendChild(sp);
        });
      }

      // Yıllık izin bilgisini getir ve DOM'a yaz
      async function loadEmployeeLeave(empId) {
        if (!empId) return;
        try {
          const res = await fetch(`/api/employees/${empId}/leave`);
          if (!res.ok) throw new Error("İzin bilgisi alınamadı");
          const data = await res.json();
          const leaveEl = document.getElementById("employeeLeave");
          if (leaveEl) {
            const remaining = data?.remaining ?? 0;
            leaveEl.textContent = `${remaining} Gün`;
          }
        } catch (err) {
          console.error(err);
          if (window.toast) toast.error("Yıllık izin verisi alınamadı");
        }
      }

      function initPeriod() {
        const { start, end, label } = getCurrentMonthRange();
        currentStartDate = start;
        currentEndDate = end;
        const periodBtn = document.querySelector("[data-role='period-label']");
        if (periodBtn) {
          periodBtn.textContent = label;
        }
      }

      async function downloadReport() {
        if (!selectedEmployeeId) {
             if(window.toast) toast.warning("Lütfen bir personel seçin");
             return;
        }
        
        const btn = document.getElementById("downloadReportBtn");
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-[20px]">sync</span> İndiriliyor...`;

        try {
            // Verileri yeniden getir veya mevcut durumu kullan? Yeniden getirmek veya belirli veriyi garanti etmek daha iyi
            // Bu personel için mevcut dönem için bir CSV özeti oluşturacağız.
            const name = document.getElementById("employeeName").innerText;
            const period = document.querySelector("[data-role='period-label']").innerText;
            
            // CSV Başlığı
            let csvContent = `Personel Detay Raporu\n`;
            csvContent += `Personel:;${name}\n`;
            csvContent += `Dönem:;${period}\n\n`;
            
            // Özet İstatistikler
            const totalWork = document.getElementById("totalWorkTime").innerText.replace('\n', ' ');
            const gross = document.getElementById("employeeGross").innerText;
            const leave = document.getElementById("employeeLeave").innerText;
            
            csvContent += `Özet Bilgiler\n`;
            csvContent += `Toplam Çalışma;${totalWork}\n`;
            csvContent += `Tahmini Hak Ediş;${gross}\n`;
            csvContent += `Kalan İzin;${leave}\n\n`;
            
            // Günlük Detaylar Başlığı
            csvContent += `Günlük Detaylar\n`;
            csvContent += `Tarih;Giriş;Çıkış;Süre (Saat)\n`;
            
            // CSV oluşturmak için detaylı logları döneme göre getir
            // currentStartDate & currentEndDate
            
            const res = await fetch(`/api/salary/calculate?startDate=${currentStartDate}&endDate=${currentEndDate}`); // This gives summary, effectively. For logs we need explicit logs endpoint or iterate days. 
            // Aslında, aralık için sadece logs endpoint'ini kullanabiliriz.
            const logsRes = await fetch(`/api/employees/${selectedEmployeeId}/logs?startDate=${currentStartDate}&endDate=${currentEndDate}`); // We need to ensure backend supports range on this endpoint or we just use the daily logic.
            // Checking backend... usually logs endpoint takes date specific or range? 
            // In daily logic we called per day. Let's try to assume there might not be a range endpoint for logs yet or it's 'calculate' that has it.
            // Let's use the 'calculate' data which we might already have, but 'calculate' returns summary totals.
            // Let's just output the summary for now to be safe, or try to reconstruct from chart data? Chart data is limited to 14 days.
            // Let's keep it simple: Download Summary Report.
            
            // Add BOM
            const BOM = "\uFEFF";
            const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `${name.replace(/\s+/g, '_')}_Rapor_${period.replace(/\s+/g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            if(window.toast) toast.success("Rapor indirildi");

        } catch (error) {
            console.error(error);
            if(window.toast) toast.error("Rapor oluşturulurken hata oluştu");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
      }

      function initPeriod() {
        // Set default to current month
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const picker = document.getElementById("reportPeriod");
        
        if (picker) {
           picker.value = `${year}-${month}`;
           
           // Init variables
           updateDateRange(year, now.getMonth());

           picker.addEventListener('change', (e) => {
              if(!e.target.value) return;
              const [y, m] = e.target.value.split('-');
              updateDateRange(parseInt(y), parseInt(m) - 1);
              
              // Refresh data
              loadSalaryForEmployee();
              loadEmployeeDailyHours(selectedEmployeeId);
              loadEmployeeLeave(selectedEmployeeId); // Refresh leave info if needed
           });
        }
      }

      function updateDateRange(year, monthIndex) {
         const first = new Date(year, monthIndex, 1);
         const last = new Date(year, monthIndex + 1, 0);
         // Adjust to local timezone offset to ensure we get correct YYYY-MM-DD
         // Or just use manual formatting to avoid timezone issues:
         const fY = first.getFullYear();
         const fM = String(first.getMonth() + 1).padStart(2, '0');
         const fD = String(first.getDate()).padStart(2, '0');
         
         const lY = last.getFullYear();
         const lM = String(last.getMonth() + 1).padStart(2, '0');
         const lD = String(last.getDate()).padStart(2, '0');
         
         currentStartDate = `${fY}-${fM}-01`; // always 01
         currentEndDate = `${lY}-${lM}-${lD}`;
      }
      
      // Initialize on load
      document.addEventListener("DOMContentLoaded", () => {
        // Eğer iframe içindeysek dış layout'u gizle
        if (window.self !== window.top) {
           document.body.classList.add("embedded-report");
        }
        
        initPeriod();
        loadEmployees().then(() => {
          loadSalaryForEmployee();
          loadEmployeeDailyHours(selectedEmployeeId);
        });
      });
    </script>
  </body>
</html>
