<!DOCTYPE html>
<html class="light" lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Keşiş Kafe - Satış Raporları</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#4CAF50",
              "primary-light": "#E8F5E9",
              "primary-dark": "#2E7D32",
              "background-light": "#F9F9F7",
              "background-dark": "#1C1C1E",
              "surface-light": "#FFFFFF",
              "surface-dark": "#2C2C2E",
              "text-main": "#2F3E2F",
              "text-secondary": "#5C6B5C",
            },
            fontFamily: {
              display: ["Work Sans", "sans-serif"],
              body: ["Work Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Work Sans", sans-serif;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #e0e0e0;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #bdbdbd;
      }

      /* Embedded (iframe içi) görünümde dış layout'u gizle */
      body.embedded-report {
        background: transparent;
        overflow: auto;
        height: auto;
      }
      body.embedded-report > aside {
        display: none;
      }
      body.embedded-report > main {
        padding: 0;
        border: none;
      }
    </style>
  </head>
    <div class="flex h-screen overflow-hidden">
      <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
      <header
        class="h-16 bg-background-light dark:bg-background-dark border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-6 shrink-0 z-10"
      >
        <div class="flex items-center gap-4">
          <button
            class="md:hidden p-2 text-text-secondary hover:bg-gray-100 rounded-lg"
          >
            <span class="material-symbols-outlined">menu</span>
          </button>
          <h2 class="text-xl font-bold text-text-main dark:text-white">
            Satış Raporları
          </h2>
        </div>
        <div class="flex items-center gap-3">
        </div>
      </header>
      <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
        <div class="max-w-7xl mx-auto flex flex-col gap-8">
          <div
            class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-surface-light dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800"
          >
            <div class="flex flex-wrap items-center gap-3">
              <div class="relative group">
                <select
                  id="periodSelector"
                  class="appearance-none flex items-center gap-2 pl-10 pr-8 py-2 bg-primary-light/50 border border-primary/20 rounded-lg text-primary-dark cursor-pointer hover:bg-primary-light transition-colors text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary/50"
                  onchange="updatePeriod(this.value)"
                >
                  <option value="today">Bugün</option>
                  <option value="week" selected>Bu Hafta</option>
                  <option value="month">Bu Ay</option>
                </select>
                <div class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none">
                  <span class="material-symbols-outlined text-[20px] text-primary-dark">calendar_today</span>
                </div>
                <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">
                  <span class="material-symbols-outlined text-[18px] text-primary-dark">expand_more</span>
                </div>
              </div>

            </div>
          </div>
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6"
          >
            <div
              class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-1 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start mb-2">
                <div
                  class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg text-blue-600 dark:text-blue-400"
                >
                  <span class="material-symbols-outlined">payments</span>
                </div>
                <span
                  id="kpiRevenueChange"
                  class="flex items-center gap-1 text-xs font-semibold text-text-secondary bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-full"
                >
                  <span class="material-symbols-outlined text-[14px]"
                    >remove</span
                  >
                  0%
                </span>
              </div>
              <p class="text-text-secondary text-sm font-medium">
                Toplam Gelir
              </p>
              <h3
                id="kpiTotalRevenue"
                class="text-2xl font-bold text-text-main dark:text-white"
              >
                ₺0,00
              </h3>
            </div>
            <div
              class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-1 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start mb-2">
                <div
                  class="bg-primary-light dark:bg-primary-dark/20 p-2 rounded-lg text-primary-dark dark:text-primary"
                >
                  <span class="material-symbols-outlined">receipt_long</span>
                </div>
                <span
                  id="kpiOrdersChange"
                  class="flex items-center gap-1 text-xs font-semibold text-text-secondary bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-full"
                >
                  <span class="material-symbols-outlined text-[14px]"
                    >remove</span
                  >
                  0%
                </span>
              </div>
              <p class="text-text-secondary text-sm font-medium">
                Toplam Sipariş
              </p>
              <h3
                id="kpiTotalOrders"
                class="text-2xl font-bold text-text-main dark:text-white"
              >
                0 Adet
              </h3>
            </div>
            <div
              class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-1 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start mb-2">
                <div
                  class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-lg text-yellow-600 dark:text-yellow-400"
                >
                  <span class="material-symbols-outlined">shopping_basket</span>
                </div>
                <span
                  id="kpiAvgChange"
                  class="flex items-center gap-1 text-xs font-semibold text-text-secondary bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-full"
                >
                  <span class="material-symbols-outlined text-[14px]"
                    >remove</span
                  >
                  0%
                </span>
              </div>
              <p class="text-text-secondary text-sm font-medium">
                Ort. Sepet Tutarı
              </p>
              <h3
                id="kpiAvgOrder"
                class="text-2xl font-bold text-text-main dark:text-white truncate"
              >
                ₺0,00
              </h3>
            </div>
            <div
              class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-1 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start mb-2">
                <div
                  class="bg-purple-50 dark:bg-purple-900/20 p-2 rounded-lg text-purple-600 dark:text-purple-400"
                >
                  <span class="material-symbols-outlined">category</span>
                </div>
                <span
                  id="kpiTopShare"
                  class="flex items-center gap-1 text-xs font-semibold text-text-secondary bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-full"
                >
                  0%
                </span>
              </div>
              <p class="text-text-secondary text-sm font-medium">
                En Çok Satan Kategori
              </p>
              <h3
                id="kpiTopCategory"
                class="text-2xl font-bold text-text-main dark:text-white"
              >
                -
              </h3>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 1. Satış Türü Dağılımı (Gel Al / Paket) -->
            <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col">
              <h3 class="text-lg font-bold text-text-main dark:text-white mb-6">
                Satış Türü Dağılımı
              </h3>
              <div class="flex-1 flex flex-col items-center justify-center gap-4">
                <svg
                  id="weeklyPie"
                  class="w-40 h-40"
                  viewBox="0 0 160 160"
                  aria-label="Gel Al / Paket Servis dağılımı"
                ></svg>
                <div
                  id="weeklyPieLegend"
                  class="flex flex-col gap-2 text-sm text-text-secondary w-full px-4"
                ></div>
              </div>
            </div>

            <!-- 2. Satış Trendi (Line Chart) -->
             <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col">
              <div class="flex justify-between items-center mb-6">
                <h3 id="salesTrendTitle" class="text-lg font-bold text-text-main dark:text-white">
                  Satış Trendi
                </h3>
              </div>
              <div class="flex-1 w-full flex items-center">
                <svg
                  id="weeklySalesChart"
                  class="w-full h-32 overflow-visible"
                  preserveAspectRatio="none"
                  viewBox="0 0 200 80"
                  aria-label="Satış trendi grafiği"
                ></svg>
              </div>
            </div>

            <!-- 3. Kategori Bazlı Gelir -->
            <div
              class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col"
            >
              <h3 class="text-lg font-bold text-text-main dark:text-white mb-6">
                Kategori Bazlı Gelir
              </h3>
              <div class="flex-1 flex items-center justify-center relative">
                <svg
                  id="categoryDonut"
                  class="w-48 h-48"
                  viewBox="0 0 160 160"
                ></svg>
              </div>
              <div
                id="categoryLegend"
                class="mt-6 flex flex-col gap-3 text-sm"
              ></div>
            </div>
          </div>
          <div
            class="bg-surface-light dark:bg-surface-dark rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden mb-8"
          >
            <div
              class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-col gap-4"
            >
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
              >
                <div>
                  <h3 class="text-lg font-bold text-text-main dark:text-white">
                    Ürün Bazlı Satış Detayları
                  </h3>
                  <p class="text-sm text-text-secondary mt-1">
                    En çok satan ürünler ve performans analizi
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    class="flex items-center justify-center size-9 border border-gray-200 dark:border-gray-700 rounded-lg text-text-secondary hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors bg-white dark:bg-surface-dark shadow-sm"
                  >
                    <span class="material-symbols-outlined text-[20px]"
                      >refresh</span
                    >
                  </button>
                  <div class="relative">
                    <span
                      class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[18px]"
                      >search</span
                    >
                    <input
                      class="pl-9 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 focus:ring-1 focus:ring-primary focus:border-primary w-full sm:w-64"
                      placeholder="Ürün ara..."
                      type="text"
                    />
                  </div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3 pt-2">
                <select
                  class="text-sm border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-text-secondary focus:ring-primary focus:border-primary py-1.5 px-3"
                >
                  <option>Tüm Kategoriler</option>
                  <option>Sıcak Kahve</option>
                  <option>Soğuk Kahve</option>
                  <option>Tatlılar</option>
                </select>
                <select
                  class="text-sm border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-text-secondary focus:ring-primary focus:border-primary py-1.5 px-3"
                >
                  <option>Tüm Fiyat Aralıkları</option>
                  <option>0-50 ₺</option>
                  <option>50-100 ₺</option>
                  <option>100+ ₺</option>
                </select>
                <select
                  class="text-sm border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-text-secondary focus:ring-primary focus:border-primary py-1.5 px-3"
                >
                  <option>Sırala: Gelir (Yüksek)</option>
                  <option>Sırala: Adet (Yüksek)</option>
                  <option>Sırala: İsim (A-Z)</option>
                </select>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead
                  class="bg-gray-50 dark:bg-gray-800/50 text-text-secondary font-medium border-b border-gray-100 dark:border-gray-800"
                >
                  <tr>
                    <th class="px-6 py-4">Ürün Adı</th>
                    <th class="px-6 py-4">Kategori</th>
                    <th class="px-6 py-4">Satılan Adet</th>
                    <th class="px-6 py-4">Birim Fiyat</th>
                    <th class="px-6 py-4">Toplam Gelir</th>
                    <th class="px-6 py-4">Stok Durumu</th>
                    <th class="px-6 py-4 text-right">Detay</th>
                  </tr>
                </thead>
                <tbody
                  id="topProductsBody"
                  class="divide-y divide-gray-100 dark:divide-gray-800"
                >
                  <tr>
                    <td
                      colspan="7"
                      class="px-6 py-6 text-center text-sm text-text-secondary"
                    >
                      Yükleniyor...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div
              class="px-6 py-4 border-t border-gray-100 dark:border-gray-800 flex items-center justify-between"
            >
              <span class="text-sm text-text-secondary"
                >1-4 / 48 ürün gösteriliyor</span
              >
              <div class="flex gap-2">
                <button
                  class="px-3 py-1 text-sm border border-gray-200 dark:border-gray-700 rounded-md text-text-secondary hover:bg-gray-50 dark:hover:bg-gray-800 disabled:opacity-50"
                  disabled=""
                >
                  Önceki
                </button>
                <button
                  class="px-3 py-1 text-sm border border-gray-200 dark:border-gray-700 rounded-md text-text-secondary hover:bg-gray-50 dark:hover:bg-gray-800"
                >
                  Sonraki
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script>
       // Global durum
      let currentPeriod = "week";
      let productSearch = "";
      let productCategory = "";

       // Para birimi formatla
      const formatCurrency = (value) => {
        return `₺${Number(value || 0).toLocaleString("tr-TR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })}`;
      };

       // Sayı formatla
      const formatNumber = (value) => {
        return Number(value || 0).toLocaleString("tr-TR");
      };

       // Dönem değişimini işle
      function updatePeriod(period) {
        currentPeriod = period;
        
        // Döneme göre trend başlığını güncelle
        const trendTitle = document.getElementById("salesTrendTitle");
        if (trendTitle) {
          if (period === 'today') trendTitle.textContent = "Günlük Satış Trendi";
          else if (period === 'week') trendTitle.textContent = "Haftalık Satış Trendi";
          else if (period === 'month') trendTitle.textContent = "Aylık Satış Trendi";
        }

        loadAllData();
      }

       // Ana yükleme fonksiyonu
      async function loadAllData() {
        try {
           // Daha iyi performans için paralel yükleme
          await Promise.all([
            loadStats(),
            loadTrendChart(),
            loadWeeklyPie(),
            loadCategoryDonut(),
            loadTopProducts()
          ]);
        } catch (error) {
          console.error("Data load error:", error);
          if(window.toast) window.toast.error("Veriler yüklenirken hata oluştu");
        }
      }

       // Eksikse basit toast ekle (yedek)
      if (!window.toast) {
        window.toast = {
          error: console.error,
          success: console.log
        };
      }

       // İstatistik Kartlarını Yükle
      async function loadStats() {
        try {
           // İstatistikleri Getir
          const statsRes = await fetch(`/api/sales/stats?period=${currentPeriod}`);
          const stats = await statsRes.json();
          
          document.getElementById("kpiTotalRevenue").textContent = formatCurrency(stats.total_revenue);
          document.getElementById("kpiTotalOrders").textContent = `${formatNumber(stats.total_orders)} Adet`;
          document.getElementById("kpiAvgOrder").textContent = formatCurrency(stats.avg_order_value);

           // Değişimleri Getir (Önceki dönemle karşılaştırma)
          const changeRes = await fetch(`/api/sales/change-percentages?period=${currentPeriod}`);
          const changes = await changeRes.json();
          
          
          updateChangeBadge("kpiRevenueChange", changes.revenue_change);
          updateChangeBadge("kpiOrdersChange", changes.quantity_change);
          updateChangeBadge("kpiAvgChange", changes.avg_order_change);

           // En İyi Kategori KPI için Kategori Verilerini Getir (yeni)
          const catRes = await fetch(`/api/sales/by-category?period=${currentPeriod}`);
          const categories = await catRes.json();
          
          if (categories && categories.length > 0) {
             // En yüksek gelirli kategoriyi bul
             const topCat = categories.reduce((prev, current) => 
                (parseFloat(prev.revenue) > parseFloat(current.revenue)) ? prev : current
             );
             
             const totalRev = categories.reduce((sum, item) => sum + parseFloat(item.revenue), 0);
             const share = totalRev > 0 ? (parseFloat(topCat.revenue) / totalRev) * 100 : 0;
             
             document.getElementById("kpiTopCategory").textContent = topCat.category;
             
             const shareEl = document.getElementById("kpiTopShare");
             shareEl.textContent = `${share.toFixed(1)}%`;
             // Verisi varsa yeşil yap
             shareEl.className = "flex items-center gap-1 text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-full";
          } else {
             document.getElementById("kpiTopCategory").textContent = "-";
             document.getElementById("kpiTopShare").textContent = "0%";
          }

        } catch (error) {
           console.error("Load stats error:", error);
        }
      }

      function updateChangeBadge(id, value) {
        const el = document.getElementById(id);
        if (!el) return;
        
        const change = parseFloat(value || 0);
        const isPositive = change > 0;
        const isNegative = change < 0;
        
        el.className = `flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full ${
          isPositive ? "text-green-600 bg-green-50" : 
          isNegative ? "text-red-600 bg-red-50" : "text-gray-600 bg-gray-50"
        }`;
        
        el.innerHTML = `
          <span class="material-symbols-outlined text-[14px]">
            ${isPositive ? "arrow_upward" : isNegative ? "arrow_downward" : "remove"}
          </span>
          ${Math.abs(change).toFixed(1)}%
        `;
      }

       // Trend Grafiğini Yükle (Gün/Hafta/Ay için Dinamik)
      async function loadTrendChart() {
        try {
          let url = "/api/sales/weekly";
          if (currentPeriod === 'today') url = "/api/sales/daily";
          else if (currentPeriod === 'month') url = "/api/sales/monthly";

          const res = await fetch(url);
          if (!res.ok) throw new Error("Chart data fetch failed");
          let data = await res.json();
          
          const svg = document.getElementById("weeklySalesChart");
          if (!svg) return;

          let sortedData = [];
          let labels = [];

          if (currentPeriod === 'today') {
               // Tam 24 saatlik dizi oluştur
              const fullDay = Array.from({length: 24}, (_, i) => ({
                  hour: i,
                  daily_total: 0,
                  label: `${i}:00`
              }));
              
              // Gerçek verilerle doldur
              data.forEach(d => {
                  if(fullDay[d.hour]) fullDay[d.hour].daily_total = parseFloat(d.daily_total);
              });
              
              sortedData = fullDay;
          } else if (currentPeriod === 'week' || currentPeriod === 'month') {
             // Hafta/ay için, verinin seyrek olabileceğini varsayıyoruz, ancak genellikle API mevcut günleri döndürür.
             // İdeal olarak burada da boşlukları doldurmalıyız, ancak şimdilik sadece sıralayalım.
             sortedData = [...data].sort((a, b) => new Date(a.sale_date) - new Date(b.sale_date));
             
             // Etiketleri formatla
             sortedData.forEach(d => {
                 const date = new Date(d.sale_date);
                 d.label = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
             });
          }

          if (sortedData.length === 0) {
             svg.innerHTML = '<text x="100" y="40" text-anchor="middle" fill="#9ca3af" font-size="10">Veri yok</text>';
             return;
          }

           // Boyutlar
          const width = 200;
          const height = 80;
          const padding = 10;
          const chartWidth = width - padding * 2;
          const chartHeight = height - padding * 2;

           // Ölçekler
          const maxVal = Math.max(...sortedData.map(d => parseFloat(d.daily_total)), 1);
          
          const points = sortedData.map((d, i) => {
             const x = padding + (i / (sortedData.length - 1 || 1)) * chartWidth;
             const y = height - padding - (parseFloat(d.daily_total) / maxVal) * chartHeight;
             return `${x},${y}`;
          }).join(" ");

           // Gradyan
          const defs = `
            <defs>
              <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#4CAF50" stop-opacity="0.2"/>
                <stop offset="100%" stop-color="#4CAF50" stop-opacity="0"/>
              </linearGradient>
            </defs>
          `;

           // Alan yolu
          const pointArray = points.split(" ");
          const startX = pointArray[0].split(",")[0];
          const endX = pointArray[pointArray.length - 1].split(",")[0];
           const areaPath = `M${startX},${height - padding} L${points} L${endX},${height - padding} Z`; // Sabit alt Y

           // Basit eksen etiketleri oluştur (başlangıç, orta, bitiş)
          const axisLabels = `
             <text x="${padding}" y="${height+2}" font-size="8" fill="#9ca3af" text-anchor="start">${sortedData[0].label}</text>
             <text x="${width/2}" y="${height+2}" font-size="8" fill="#9ca3af" text-anchor="middle">${sortedData[Math.floor(sortedData.length/2)].label}</text>
             <text x="${width-padding}" y="${height+2}" font-size="8" fill="#9ca3af" text-anchor="end">${sortedData[sortedData.length-1].label}</text>
          `;

          svg.innerHTML = `
            ${defs}
            <path d="${areaPath}" fill="url(#chartGradient)" />
            <path d="M${points}" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            ${sortedData.map((d,i) => {
               const x = padding + (i / (sortedData.length - 1 || 1)) * chartWidth;
               const y = height - padding - (parseFloat(d.daily_total) / maxVal) * chartHeight;
               const val = formatCurrency(d.daily_total);
               
               // Geliştirilmiş tooltip: daha büyük kutu, daha iyi konumlandırma, SVG sınıfı ile taşma düzeltildi
               return `
                 <g class="chart-point group">
                   <circle cx="${x}" cy="${y}" r="3" fill="#4CAF50" stroke="white" stroke-width="1" class="cursor-pointer hover:r-5 transition-all"/>
                   <!-- Tooltip Konteyner -->
                   <g class="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" style="transform: translateY(-40px);">
                      <rect x="${x - 40}" y="${y - 5}" width="80" height="35" rx="6" fill="#1f2937" stroke="#374151" stroke-width="1" filter="drop-shadow(0 4px 6px rgba(0,0,0,0.1))" />
                       <!-- Üçgen/Ok -->
                      <path d="M${x},${y+30} L${x-5},${y+30} L${x},${y+35} L${x+5},${y+30} Z" fill="#1f2937" />
                      
                      <text x="${x}" y="${y + 12}" text-anchor="middle" fill="white" font-size="9" font-weight="bold" font-family="sans-serif">${val}</text>
                      <text x="${x}" y="${y + 24}" text-anchor="middle" fill="#9ca3af" font-size="8" font-family="sans-serif">${d.label}</text>
                   </g>
                 </g>
               `;
            }).join("")}
            ${axisLabels}
          `;

           // Gerekirse üstten taşmaya izin vermek için viewBox'ı ayarla (gerçi overflow-visible yardımcı olur)
           // aslında standart viewBox, overflow visible ise iyidir
          svg.setAttribute("viewBox", `0 -10 200 110`); 

        } catch (err) {
          console.error("Load trend chart error:", err);
        }
      }

       // Satış Türü Pasta Grafiğini Yükle (Gel Al vs Paket)
      async function loadWeeklyPie() {
        try {
          const res = await fetch(`/api/sales/type-breakdown?period=${currentPeriod}`);
          if (!res.ok) throw new Error("Type breakdown fetch failed");
          const data = await res.json();
          
          const svg = document.getElementById("weeklyPie");
          const legend = document.getElementById("weeklyPieLegend");
          if (!svg) return;

          const types = data.types || [];
          if (!types.length) {
            svg.innerHTML = '<circle cx="50%" cy="50%" r="45%" fill="#f3f4f6" />';
            return;
          }

          let currentAngle = 0;
          const total = data.total_revenue || 1;
           const colors = ["#4CAF50", "#2196F3", "#FFC107"]; // Yeşil, Mavi, Amber

          let paths = "";
           // Merkez 80,80 (viewBox 0 0 160 160)
          const cx = 80;
          const cy = 80;
          const r = 80;

           // Basit Pasta Grafiği
          types.forEach((type, i) => {
            const val = parseFloat(type.total_revenue);
            const sliceAngle = (val / total) * Math.PI * 2;
            if (sliceAngle === 0) return;

            const x1 = cx + r * Math.cos(currentAngle);
            const y1 = cy + r * Math.sin(currentAngle);
            const x2 = cx + r * Math.cos(currentAngle + sliceAngle);
            const y2 = cy + r * Math.sin(currentAngle + sliceAngle);
            
            // Büyük yay bayrağı
            const largeArc = sliceAngle > Math.PI ? 1 : 0;
            
            // Eğer tam daire ise
            if (Math.abs(sliceAngle - Math.PI * 2) < 0.001) {
               paths += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${colors[i % colors.length]}" />`;
            } else {
               paths += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc} 1 ${x2},${y2} Z" fill="${colors[i % colors.length]}" />`;
            }
            
            currentAngle += sliceAngle;
          });

           // Donut efekti için iç beyaz daire
          paths += `<circle cx="${cx}" cy="${cy}" r="${r * 0.6}" fill="white" dark:fill="#2C2C2E" />`;
          
          svg.innerHTML = paths;

           // Lejantı düzgün güncelle
          if (legend) {
             legend.innerHTML = types.map((t, i) => `
                <div class="flex items-center gap-1">
                   <span class="w-2 h-2 rounded-full" style="background-color: ${colors[i % colors.length]}"></span>
                   <span>${t.name}: ${Math.round(t.revenue_percent)}%</span>
                </div>
             `).join("");
          }

        } catch (err) {
          console.error("Load weekly pie error:", err);
        }
      }

      async function loadCategoryDonut() {
        try {
          const res = await fetch(`/api/sales/by-category?period=${currentPeriod}`);
          if (!res.ok) throw new Error("Kategori verisi alınamadı");
          const data = await res.json();
          const svg = document.getElementById("categoryDonut");
          const legend = document.getElementById("categoryLegend");
          if (!svg || !legend) return;

          if (!data.length) {
            svg.innerHTML =
              '<text x="80" y="80" text-anchor="middle" fill="#9ca3af">Veri yok</text>';
            legend.innerHTML = "";
            return;
          }

          const categoryColors = {
            "İçecek": "#22c55e",
            "İçecekler": "#22c55e",
            "Yiyecek": "#f97316",
            "Yiyecekler": "#f97316",
            "Tatlı": "#a855f7",
            "Tatlılar": "#a855f7",
            "Kahve": "#8b5cf6",
            "Kahveler": "#8b5cf6",
          };

          const palette = [
            "#22c55e", // yeşil
            "#f97316", // turuncu
            "#0ea5e9", // mavi
            "#a855f7", // mor
            "#f59e0b", // amber
            "#ef4444", // kırmızı
            "#6366f1", // indigo
          ];

          let currentAngle = 0;
          let donutParts = "";
          const totalRevenue = data.reduce(
            (sum, item) => sum + (parseFloat(item.revenue) || 0),
            0
          );

          data.forEach((item, index) => {
            const revenue = parseFloat(item.revenue) || 0;
            const value = totalRevenue ? (revenue / totalRevenue) * 100 : 0;
            const angle = (value / 100) * Math.PI * 2;
            const x1 = 80 + 60 * Math.cos(currentAngle);
            const y1 = 80 + 60 * Math.sin(currentAngle);
            const x2 = 80 + 60 * Math.cos(currentAngle + angle);
            const y2 = 80 + 60 * Math.sin(currentAngle + angle);
            const largeArc = angle > Math.PI ? 1 : 0;
            
            const color = categoryColors[item.category] || palette[index % palette.length];

            donutParts += `
              <path
                d="M80,80 L${x1},${y1} A60,60 0 ${largeArc} 1 ${x2},${y2} Z"
                fill="${color}"
                fill-opacity="0.9"
              />
            `;
            currentAngle += angle;
          });

          const innerCircle = `
            <circle cx="80" cy="80" r="38" fill="white" />
          `;

          svg.innerHTML = donutParts + innerCircle;

          legend.innerHTML = data
            .map((item, index) => {
              const revenue = parseFloat(item.revenue) || 0;
              const pct = totalRevenue ? (revenue / totalRevenue) * 100 : 0;
              const color = categoryColors[item.category] || palette[index % palette.length];
              return `
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="size-3 rounded-full" style="background:${color}"></span>
                    <span class="text-text-secondary">${item.category}</span>
                  </div>
                  <span class="font-semibold text-text-main dark:text-white">
                    ${pct.toFixed(1)}%
                  </span>
                </div>
              `;
            })
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      async function loadTopProducts() {
        const tbody = document.getElementById("topProductsBody");
        if (!tbody) return;
        try {
          const res = await fetch(
            `/api/sales/top-products?period=${currentPeriod}&limit=10`
          );
          if (!res.ok) throw new Error("Top ürünler alınamadı");
          const data = await res.json();

          if (!data.length) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" class="px-6 py-6 text-center text-sm text-text-secondary">
                  Kayıt bulunamadı
                </td>
              </tr>
            `;
            return;
          }

          tbody.innerHTML = data
            .map((item) => {
              const revenue = formatCurrency(item.total_revenue || 0);
              const sold = formatNumber(item.total_sold || 0);
              const price = formatCurrency(item.price || 0);
              const initials = (item.name?.[0] || "?").toUpperCase();

              return `
                <tr class="hover:bg-gray-50/50 dark:hover:bg-gray-800/30 transition-colors group">
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <div class="size-10 rounded-lg bg-green-100 text-green-600 border border-green-200 flex items-center justify-center font-bold">
                        ${initials}
                      </div>
                      <div>
                        <div class="font-medium text-text-main dark:text-white">
                          ${item.name}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                      ${item.category || "-"}
                    </span>
                  </td>
                  <td class="px-6 py-4">
                    <span class="font-bold text-text-main dark:text-white">
                      ${sold}
                    </span>
                  </td>
                  <td class="px-6 py-4 text-text-secondary">
                    ${price}
                  </td>
                  <td class="px-6 py-4">
                    <div class="font-bold text-text-main dark:text-white">
                      ${revenue}
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span class="flex items-center gap-1.5 text-sm text-text-secondary">
                      <span class="relative flex h-2.5 w-2.5">
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                      </span>
                      Aktif
                    </span>
                  </td>
                  <td class="px-6 py-4 text-right">
                    <button
                      class="text-gray-400 hover:text-primary transition-colors bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-1.5 shadow-sm"
                    >
                      <span class="material-symbols-outlined text-[18px]">
                        visibility
                      </span>
                    </button>
                  </td>
                </tr>
              `;
            })
            .join("");
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-6 text-center text-sm text-red-600">
                Ürün verileri yüklenirken hata oluştu
              </td>
            </tr>
          `;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Initial Load
        loadAllData();

        // Debounced resize: re-render small charts for responsive layout
        let resizeTimer = null;
        window.addEventListener("resize", () => {
          if (resizeTimer) clearTimeout(resizeTimer);
          resizeTimer = setTimeout(() => {
            loadTrendChart();
            loadCategoryDonut();
            loadWeeklyPie();
          }, 150);
        });
      });
    </script>
    </main>
    </div> <!-- Close flex h-screen -->
    <script src="/components/toast.js"></script>

    <!-- ApexCharts for better charting (optional but recommended over raw SVG manual paths if possible, but sticking to provided code style implies using what's there or simple solutions) -->
    <!-- Using the existing script block below, will enhance it -->
    <script>
      // ... existing script content ...
    </script>
  </body>
</html>
