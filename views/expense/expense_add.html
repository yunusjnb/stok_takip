<!DOCTYPE html>
<html class="light" lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Özel Gider Girişi - Keşiş Kafe</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#5bec13",
              "primary-dark": "#4cd00e",
              "background-light": "#f9fcf8",
              "background-dark": "#162210",
              "surface-light": "#ffffff",
              "surface-dark": "#1f2e18",
              "text-main": "#121b0d",
              "text-muted": "#669a4c",
              "primary-light": "#e8f5e3",
              "primary-darker": "#3a8a0e",
            },
            fontFamily: {
              display: ["Work Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #d7e7cf;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #669a4c;
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
  </head>
  <body
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-gray-100 font-display min-h-screen flex flex-col md:flex-row overflow-hidden"
  >
    <div id="sidebar-container"></div>
    <main class="flex-1 flex flex-col h-screen overflow-y-auto relative">
      <div class="px-6 py-4 md:px-10 pt-8 pb-2">
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <a
            class="text-text-muted hover:text-primary dark:text-gray-400 transition-colors font-medium"
            href="/dashboard"
            >Ana Sayfa</a
          >
          <span class="material-symbols-outlined text-xs text-gray-400"
            >chevron_right</span
          >
          <span class="text-text-main dark:text-primary font-semibold"
            >Özel Gider Girişi</span
          >
        </div>
      </div>
      <div
        class="px-6 md:px-10 py-4 flex flex-col md:flex-row md:items-end justify-between gap-4 max-w-7xl mx-auto w-full"
      >
        <div class="max-w-2xl">
          <h2
            class="text-3xl md:text-4xl font-black text-text-main dark:text-white tracking-tight mb-2"
          >
            Özel Gider Girişi
          </h2>
          <p class="text-text-muted dark:text-gray-400 text-base md:text-lg">
            İşletme için yapılan harici harcamaları (kira, fatura, bakım)
            buradan sisteme ekleyebilirsiniz.
          </p>
        </div>
        <div class="hidden md:block">
          <div
            id="currentDate"
            class="inline-flex items-center px-4 py-2 bg-white dark:bg-surface-dark border border-[#d7e7cf] dark:border-gray-700 rounded-lg text-sm text-text-muted dark:text-gray-300 shadow-sm"
          >
            <span class="material-symbols-outlined mr-2 text-primary"
              >calendar_today</span
            >
            <span>Bugün: Yükleniyor...</span>
          </div>
        </div>
      </div>
      <div class="px-6 md:px-10 py-6 pb-20 max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 flex flex-col gap-6">
            <form
              id="expenseForm"
              class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-[0_2px_12px_-4px_rgba(0,0,0,0.05)] border border-[#d7e7cf] dark:border-gray-700 p-6 md:p-8"
            >
              <div class="flex flex-col gap-6">
                <div
                  class="flex items-center gap-3 border-b border-[#d7e7cf] dark:border-gray-700 pb-4"
                >
                  <div class="bg-primary/20 p-2 rounded-lg">
                    <span
                      class="material-symbols-outlined text-primary-dark dark:text-primary"
                      >edit_document</span
                    >
                  </div>
                  <h3 class="text-lg font-bold text-text-main dark:text-white">
                    Gider Detayları
                  </h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="flex flex-col gap-2 md:col-span-2">
                    <label
                      class="text-text-main dark:text-gray-200 text-sm font-semibold"
                      >Gider Türü <span class="text-red-500">*</span></label
                    >
                    <div class="relative">
                      <select
                        id="expenseType"
                        required
                        class="w-full appearance-none rounded-lg bg-background-light dark:bg-background-dark border border-[#d7e7cf] dark:border-gray-600 text-text-main dark:text-white h-12 px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base"
                      >
                        <option disabled selected value="">
                          Kategori Seçiniz
                        </option>
                      </select>
                      <span
                        class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-text-muted"
                        >expand_more</span
                      >
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <label
                      class="text-text-main dark:text-gray-200 text-sm font-semibold"
                      >Tutar (₺) <span class="text-red-500">*</span></label
                    >
                    <div class="relative">
                      <input
                        id="expensePrice"
                        required
                        class="w-full rounded-lg bg-background-light dark:bg-background-dark border border-[#d7e7cf] dark:border-gray-600 text-text-main dark:text-white h-12 pl-10 pr-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base font-medium"
                        placeholder="0.00"
                        type="number"
                        step="0.01"
                        min="0"
                      />
                      <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-muted text-lg"
                        >payments</span
                      >
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <label
                      class="text-text-main dark:text-gray-200 text-sm font-semibold"
                      >Tarih <span class="text-red-500">*</span></label
                    >
                    <div class="relative">
                      <input
                        id="expenseDate"
                        required
                        class="w-full rounded-lg bg-background-light dark:bg-background-dark border border-[#d7e7cf] dark:border-gray-600 text-text-main dark:text-white h-12 px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base font-medium"
                        type="date"
                      />
                    </div>
                  </div>
                  <div class="flex flex-col gap-2 md:col-span-2">
                    <label
                      class="text-text-main dark:text-gray-200 text-sm font-semibold"
                      >Gider Adı <span class="text-red-500">*</span></label
                    >
                    <input
                      id="expenseName"
                      required
                      class="w-full rounded-lg bg-background-light dark:bg-background-dark border border-[#d7e7cf] dark:border-gray-600 text-text-main dark:text-white h-12 px-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base font-medium"
                      placeholder="Gider adı (örn: Kasım Elektrik Faturası)"
                      type="text"
                    />
                  </div>
                  <div class="flex flex-col gap-2 md:col-span-2">
                    <label
                      class="text-text-main dark:text-gray-200 text-sm font-semibold"
                      >Açıklama
                      <span class="text-text-muted font-normal text-xs"
                        >(Opsiyonel)</span
                      ></label
                    >
                    <textarea
                      id="expenseDescription"
                      class="w-full rounded-lg bg-background-light dark:bg-background-dark border border-[#d7e7cf] dark:border-gray-600 text-text-main dark:text-white p-4 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base resize-none"
                      placeholder="Ek açıklama (opsiyonel)"
                      rows="3"
                    ></textarea>
                  </div>
                </div>
                <div
                  class="flex items-center justify-end gap-4 pt-4 mt-2 border-t border-[#d7e7cf] dark:border-gray-700"
                >
                  <button
                    id="cancelBtn"
                    class="px-6 py-3 rounded-lg text-text-muted dark:text-gray-300 font-medium hover:bg-[#ebf3e7] dark:hover:bg-gray-800 transition-colors"
                    type="button"
                  >
                    Vazgeç
                  </button>
                  <button
                    id="saveBtn"
                    class="px-8 py-3 rounded-lg bg-primary hover:bg-primary-dark text-black font-bold shadow-md hover:shadow-lg transition-all flex items-center gap-2"
                    type="submit"
                  >
                    <span class="material-symbols-outlined text-lg">save</span>
                    Gideri Kaydet
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="flex flex-col gap-6">
            <div
              class="bg-surface-light dark:bg-surface-dark rounded-xl p-6 shadow-sm border border-[#d7e7cf] dark:border-gray-700 relative overflow-hidden"
            >
              <div
                class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-primary/20 blur-2xl"
              ></div>
              <h4
                class="text-sm font-semibold text-text-muted dark:text-gray-400 uppercase tracking-wider mb-2"
              >
                Bu Ay Toplam Gider
              </h4>
              <div
                id="monthlyTotal"
                class="text-4xl font-black text-text-main dark:text-white tracking-tight"
              >
                ₺0.00
              </div>
              <div
                id="monthlyChange"
                class="flex items-center gap-1 mt-2 text-sm font-medium"
              >
                <span class="material-symbols-outlined text-base"
                  >trending_up</span
                >
                <span>Yükleniyor...</span>
              </div>
            </div>
            <div
              class="bg-surface-light dark:bg-surface-dark rounded-xl border border-[#d7e7cf] dark:border-gray-700 flex flex-col overflow-hidden"
            >
              <div
                class="p-4 border-b border-[#d7e7cf] dark:border-gray-700 bg-[#fbfdfa] dark:bg-surface-dark flex justify-between items-center"
              >
                <h4 class="font-bold text-text-main dark:text-white text-sm">
                  Son Eklenenler
                </h4>
              </div>
              <div
                id="recentExpenses"
                class="flex flex-col divide-y divide-[#d7e7cf] dark:divide-gray-700"
              >
                <div class="p-4 text-center text-text-muted">Yükleniyor...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Description Modal -->
    <div id="descModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeDescModal()"></div>
        
        <!-- Modal Panel -->
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-surface-dark text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-[#d7e7cf] dark:border-gray-700">
                    <div class="bg-white dark:bg-surface-dark px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary/20 sm:mx-0 sm:h-10 sm:w-10">
                                <span class="material-symbols-outlined text-primary-dark">description</span>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-lg font-bold leading-6 text-text-main dark:text-white" id="modal-title">Gider Açıklaması</h3>
                                <div class="mt-4">
                                    <p id="descModalContent" class="text-sm text-text-secondary dark:text-gray-300 bg-[#f9fcf8] dark:bg-gray-800/50 p-4 rounded-xl border border-[#edf5ea] dark:border-gray-700 leading-relaxed">
                                        <!-- Content -->
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#f9fcf8] dark:bg-surface-dark/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-[#d7e7cf] dark:border-gray-700">
                        <button type="button" onclick="closeDescModal()" class="inline-flex w-full justify-center rounded-xl bg-primary px-3 py-2 text-sm font-bold text-white shadow-sm hover:bg-primary-dark sm:ml-3 sm:w-auto transition-colors">
                            Tamam
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
      function showDescModal(content) {
          const modal = document.getElementById('descModal');
          const contentEl = document.getElementById('descModalContent');
          contentEl.textContent = content || 'Açıklama bulunmuyor.';
          modal.classList.remove('hidden');
      }

      function closeDescModal() {
          document.getElementById('descModal').classList.add('hidden');
      }
      
      document.addEventListener('keydown', function(event) {
          if (event.key === "Escape") {
              closeDescModal();
          }
      });
    </script>
    <script src="/components/toast.js"></script>
    <script src="/components/sidebar.js"></script>
    <script>
      let expenseTypes = [];

      // Yetki kontrolü
      (function guardAdmin() {
        const userType = localStorage.getItem("userType");
        if (!userType) {
          window.location.href = "/";
          return;
        }
        if (userType === "kasa") {
          window.location.href = "/cashier";
        }
      })();

      // Bugünün tarihini göster
      function updateCurrentDate() {
        const today = new Date();
        const options = { year: "numeric", month: "long", day: "numeric" };
        const dateStr = today.toLocaleDateString("tr-TR", options);
        document
          .getElementById("currentDate")
          .querySelector("span:last-child").textContent = `Bugün: ${dateStr}`;
      }

      // Gider tiplerini yükle
      async function loadExpenseTypes() {
        try {
          const response = await fetch("/api/expenses/types");
          expenseTypes = await response.json();

          const select = document.getElementById("expenseType");
          select.innerHTML =
            '<option disabled selected value="">Kategori Seçiniz</option>';

          expenseTypes.forEach((type) => {
            const option = document.createElement("option");
            option.value = type.id;
            option.textContent = type.type_name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Load expense types error:", error);
          toast.error("Gider tipleri yüklenirken hata oluştu");
        }
      }

      // Bu ay toplam gideri yükle
      async function loadMonthlyTotal() {
        try {
          const response = await fetch("/api/expenses/monthly-total");
          const data = await response.json();

          document.getElementById("monthlyTotal").textContent = `₺${parseFloat(
            data.total || 0
          ).toFixed(2)}`;

          const changeDiv = document.getElementById("monthlyChange");
          const changePercent = Math.abs(data.changePercent || 0);
          const isIncrease = data.isIncrease;

          if (changePercent > 0) {
            changeDiv.className = `flex items-center gap-1 mt-2 text-sm font-medium ${
              isIncrease ? "text-red-500" : "text-green-500"
            }`;
            changeDiv.innerHTML = `
              <span class="material-symbols-outlined text-base">${
                isIncrease ? "trending_up" : "trending_down"
              }</span>
              <span>Geçen aya göre %${changePercent.toFixed(1)} ${
              isIncrease ? "artış" : "azalış"
            }</span>
            `;
          } else {
            changeDiv.className =
              "flex items-center gap-1 mt-2 text-sm font-medium text-text-muted";
            changeDiv.innerHTML = `
              <span class="material-symbols-outlined text-base">remove</span>
              <span>Değişiklik yok</span>
            `;
          }
        } catch (error) {
          console.error("Load monthly total error:", error);
        }
      }

      // Son eklenen giderleri yükle
      async function loadRecentExpenses() {
        try {
          const response = await fetch("/api/expenses/recent?limit=3");
          const expenses = await response.json();

          const container = document.getElementById("recentExpenses");

          if (expenses.length === 0) {
            container.innerHTML = `
              <div class="p-4 text-center text-text-muted">
                Henüz gider eklenmemiş
              </div>
            `;
            return;
          }

          // Gider tipine göre ikon ve stil belirle
          const getTypeInfo = (typeName) => {
            const type = (typeName || "").toLowerCase();
            if (type.includes("elektrik")) {
              return {
                icon: "bolt",
                bg: "bg-orange-100",
                text: "text-orange-600",
                darkBg: "dark:bg-orange-900",
                darkText: "dark:text-orange-300",
              };
            }
            if (type.includes("tamir") || type.includes("bakım")) {
              return {
                icon: "build",
                bg: "bg-blue-100",
                text: "text-blue-600",
                darkBg: "dark:bg-blue-900",
                darkText: "dark:text-blue-300",
              };
            }
            if (type.includes("temizlik")) {
              return {
                icon: "cleaning_services",
                bg: "bg-green-100",
                text: "text-green-700",
                darkBg: "dark:bg-green-900",
                darkText: "dark:text-green-300",
              };
            }
            if (type.includes("maaş")) {
              return {
                icon: "payments",
                bg: "bg-purple-100",
                text: "text-purple-600",
                darkBg: "dark:bg-purple-900",
                darkText: "dark:text-purple-300",
              };
            }
            return {
              icon: "receipt_long",
              bg: "bg-gray-100",
              text: "text-gray-600",
              darkBg: "dark:bg-gray-800",
              darkText: "dark:text-gray-300",
            };
          };

          container.innerHTML = expenses
            .map((expense) => {
              const typeInfo = getTypeInfo(expense.type_name);
              const date = new Date(expense.date);
              const dateStr = date.toLocaleDateString("tr-TR", {
                day: "numeric",
                month: "long",
              });

              return `
              <div
                class="p-4 flex items-center justify-between hover:bg-[#f9fcf8] dark:hover:bg-gray-800 transition-colors cursor-pointer group"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="w-10 h-10 rounded-full ${typeInfo.bg} ${
                typeInfo.text
              } ${typeInfo.darkBg} ${
                typeInfo.darkText
              } flex items-center justify-center"
                  >
                    <span class="material-symbols-outlined text-xl">${
                      typeInfo.icon
                    }</span>
                  </div>
                  <div class="flex flex-col">
                    <span
                      class="text-sm font-semibold text-text-main dark:text-white"
                      >${escapeHtml(expense.name)}</span
                    >
                    <span class="text-xs text-text-muted"
                      >${dateStr}</span
                    >
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="font-bold text-text-main dark:text-white">₺${parseFloat(expense.price || 0).toFixed(2)}</span>
                  <button 
                    onclick="showDescModal('${escapeHtml(expense.description || 'Açıklama yok').replace(/'/g, "\\'")}')"
                    class="p-1.5 text-text-muted hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors"
                    title="Detay Göster"
                  >
                    <span class="material-symbols-outlined text-lg">info</span>
                  </button>
                </div>
              </div>
            `;
            })
            .join("");
        } catch (error) {
          console.error("Load recent expenses error:", error);
          document.getElementById("recentExpenses").innerHTML = `
            <div class="p-4 text-center text-red-500">
              Yüklenirken hata oluştu
            </div>
          `;
        }
      }

      // Form submit
      document
        .getElementById("expenseForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const expenseType = document.getElementById("expenseType").value;
          const expenseName = document
            .getElementById("expenseName")
            .value.trim();
          const expensePrice = document.getElementById("expensePrice").value;
          const expenseDate = document.getElementById("expenseDate").value;
          const expenseDescription = document
            .getElementById("expenseDescription")
            .value.trim();

          if (!expenseType || !expenseName || !expensePrice || !expenseDate) {
            toast.warning("Lütfen tüm zorunlu alanları doldurun");
            return;
          }

          if (parseFloat(expensePrice) <= 0) {
            toast.warning("Tutar 0'dan büyük olmalıdır");
            return;
          }

          try {
            const response = await fetch("/api/expenses", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                expense_type: parseInt(expenseType),
                name: expenseName,
                price: parseFloat(expensePrice),
                date: expenseDate,
                description: expenseDescription,
              }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || "Gider eklenirken hata oluştu");
            }

            toast.success("Gider başarıyla eklendi");

            // Formu temizle
            document.getElementById("expenseForm").reset();
            document.getElementById("expenseDate").value = new Date()
              .toISOString()
              .split("T")[0];

            // Verileri yenile
            loadMonthlyTotal();
            loadRecentExpenses();
          } catch (error) {
            console.error("Add expense error:", error);
            toast.error(error.message || "Gider eklenirken hata oluştu");
          }
        });

      // Vazgeç butonu
      document.getElementById("cancelBtn").addEventListener("click", () => {
        if (confirm("Formu temizlemek istediğinize emin misiniz?")) {
          document.getElementById("expenseForm").reset();
          document.getElementById("expenseDate").value = new Date()
            .toISOString()
            .split("T")[0];
        }
      });

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Sayfa yüklendiğinde
      async function init() {
        updateCurrentDate();
        document.getElementById("expenseDate").value = new Date()
          .toISOString()
          .split("T")[0];
        await loadExpenseTypes();
        await loadMonthlyTotal();
        await loadRecentExpenses();
      }

      init();
    </script>
  </body>
</html>
