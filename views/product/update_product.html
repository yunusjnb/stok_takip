<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Ürün Güncelleme - Keşiş Kafe Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700;900&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#6A994E",
              "background-light": "#F5F5F4",
              "background-dark": "#122210",
              surface: "#FFFFFF",
              "text-primary": "#1C1917",
              "text-secondary": "#6B7280",
              "border-color": "#E5E7EB",
              "primary-light": "#F7F9F5",
              "primary-darker": "#386641",
            },
            fontFamily: {
              display: ["Work Sans", "Noto Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }
    </style>
  </head>
  <body class="bg-background-light font-display">
    <div class="relative flex min-h-screen w-full">
      <div id="sidebar-container"></div>
      <main class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-7xl mx-auto">
          <div class="flex flex-col gap-8">
            <div class="flex flex-col gap-2">
              <h1
                class="text-4xl font-black tracking-tighter text-text-primary"
              >
                Ürün Güncelle
              </h1>
              <p class="text-base font-normal text-text-secondary">
                Mevcut ürün bilgilerini ve reçetesini düzenleyin.
              </p>
            </div>
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-5">
              <div class="flex flex-col gap-6 lg:col-span-3">
                <div
                  class="rounded-xl border border-[#d1e7cf] dark:border-primary/20 bg-white dark:bg-background-dark shadow-sm"
                >
                  <div class="p-6">
                    <h3
                      class="text-2xl font-bold tracking-tight text-[#0f1b0d] dark:text-white"
                    >
                      Ürün Bilgileri
                    </h3>
                  </div>
                  <div
                    class="border-t border-[#d1e7cf] dark:border-primary/20 p-6"
                  >
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                      <div class="sm:col-span-2">
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Ürün Adı
                          </p>
                          <input
                            id="productName"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="örn. Matcha Latte"
                            required
                          />
                        </label>
                      </div>
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Fiyat
                          </p>
                          <input
                            id="productPrice"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="örn. 75"
                            type="number"
                            step="0.01"
                            min="0"
                            required
                          />
                          <div id="taxInfoDisplay" class="mt-2 text-xs text-text-secondary hidden">
                            <!-- KDV bilgileri buraya gelecek -->
                          </div>
                        </label>
                      </div>
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Ürün Tipi
                          </p>
                          <select
                            id="processType"
                            class="form-select h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white"
                            required
                          >
                            <option value="üretilen">Üretilen</option>
                            <option value="al-sat">Al-Sat</option>
                          </select>
                        </label>
                      </div>
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Kategori
                          </p>
                          <select
                            id="productType"
                            class="form-select h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white"
                            required
                          >
                            <option value="">Yükleniyor...</option>
                          </select>
                        </label>
                      </div>
                      <div class="sm:col-span-2">
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Ürün Görseli
                          </p>
                          <div
                            id="imagePreview"
                            class="flex flex-col items-center gap-6 rounded-lg border-2 border-dashed border-[#d1e7cf] px-6 py-14 dark:border-primary/30"
                          >
                            <div
                              class="flex max-w-sm flex-col items-center gap-2"
                            >
                              <img
                                id="productImageTag"
                                src=""
                                alt="Ürün Görseli"
                                class="max-w-full max-h-64 rounded-lg object-cover hidden"
                              />
                              <div id="noImagePlaceholder" class="text-center">
                                <p
                                  class="text-center text-lg font-bold tracking-tight text-[#0f1b0d] dark:text-white"
                                >
                                  Ürün Görseli
                                </p>
                                <p
                                  class="text-center text-sm font-normal text-[#0f1b0d] dark:text-gray-400"
                                >
                                  Mevcut görsel gösteriliyor
                                </p>
                              </div>
                              <div class="flex items-center gap-2 mt-3">
                                <button
                                  id="chooseImageBtn"
                                  type="button"
                                  class="px-4 py-2 bg-primary text-white rounded-md text-sm"
                                >
                                  Görsel Seç
                                </button>
                                <button
                                  id="removeImageBtn"
                                  type="button"
                                  class="px-4 py-2 bg-gray-100 text-text-primary rounded-md text-sm"
                                >
                                  Kaldır
                                </button>
                              </div>
                              <input
                                id="productImageInput"
                                type="file"
                                accept="image/*"
                                class="hidden"
                              />
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex flex-col gap-6 lg:col-span-2">
                <!-- Ürün Reçetesi (üretilen için) -->
                <div
                  id="recipeSection"
                  class="rounded-xl border border-[#d1e7cf] dark:border-primary/20 bg-white dark:bg-background-dark shadow-sm"
                >
                  <div class="p-6">
                    <h3
                      class="text-2xl font-bold tracking-tight text-[#0f1b0d] dark:text-white"
                    >
                      Ürün Reçetesi
                    </h3>
                  </div>
                  <div
                    class="border-t border-[#d1e7cf] dark:border-primary/20 p-6"
                  >
                    <div class="flex flex-col gap-4">
                      <p
                        class="text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                      >
                        Malzeme Ekle
                      </p>
                      <div
                        class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2"
                      >
                        <div
                          class="col-span-1 flex flex-col sm:col-span-2 lg:col-span-1 xl:col-span-2"
                        >
                          <select
                            id="ingredientSelect"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white"
                          >
                            <option value="">Malzeme seçin...</option>
                          </select>
                        </div>
                        <div class="col-span-1">
                          <input
                            id="ingredientQuantity"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="Miktar"
                            type="number"
                            step="0.01"
                            min="0"
                          />
                        </div>
                      </div>
                      <button
                        id="addIngredientBtn"
                        type="button"
                        class="flex h-12 min-w-[84px] w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-[#e8f3e7] px-5 text-base font-bold text-[#0f1b0d] hover:bg-[#d1e7cf] dark:bg-primary/20 dark:text-white dark:hover:bg-primary/30"
                      >
                        <span class="material-symbols-outlined">add</span>
                        <span>Malzeme Ekle</span>
                      </button>
                    </div>
                    <div
                      class="mt-6 border-t border-[#d1e7cf] dark:border-primary/20 pt-6"
                    >
                      <p
                        class="mb-4 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                      >
                        Eklenen Malzemeler
                      </p>
                      <div id="ingredientsList" class="flex flex-col gap-3">
                        <p
                          class="text-center text-sm text-[#529a4c] dark:text-primary/70 py-4"
                        >
                          Yükleniyor...
                        </p>
                      </div>
                    </div>
                  </div>
                  <div
                    class="mt-6 flex flex-col gap-4 rounded-xl border border-primary/20 bg-[#f8fcf8] p-6 dark:border-primary/30 dark:bg-background-dark/50"
                  >
                    <div class="flex items-center justify-between">
                      <p
                        class="text-lg font-bold text-[#0f1b0d] dark:text-white"
                      >
                        Toplam Maliyet
                      </p>
                      <p
                        id="totalCost"
                        class="text-2xl font-black tracking-tight text-primary dark:text-primary"
                      >
                        ₺0.00
                      </p>
                    </div>
                  </div>
                </div>
                <!-- Stok Bilgileri (al-sat için) -->
                <div
                  id="stockInfoSection"
                  class="hidden rounded-xl border border-[#d1e7cf] dark:border-primary/20 bg-white dark:bg-background-dark shadow-sm"
                >
                  <div class="p-6">
                    <h3
                      class="text-2xl font-bold tracking-tight text-[#0f1b0d] dark:text-white"
                    >
                      Stok Bilgileri
                    </h3>
                  </div>
                  <div
                    class="border-t border-[#d1e7cf] dark:border-primary/20 p-6"
                  >
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Mevcut Stok
                          </p>
                          <input
                            id="productStock"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="0"
                            type="number"
                            step="0.01"
                            min="0"
                          />
                        </label>
                      </div>
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Min. Stok
                          </p>
                          <input
                            id="productMinStock"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="0"
                            type="number"
                            step="0.01"
                            min="0"
                          />
                        </label>
                      </div>
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Tedarikçi
                          </p>
                          <select
                            id="productWholesaler"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white"
                          >
                            <option value="">
                              Tedarikçi seçin (Opsiyonel)
                            </option>
                          </select>
                        </label>
                      </div>
                      <div>
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Birim Fiyat
                          </p>
                          <input
                            id="productUnitPrice"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="0.00"
                            type="number"
                            step="0.01"
                            min="0"
                            required
                          />
                        </label>
                      </div>
                      <div class="sm:col-span-2">
                        <label class="flex flex-col">
                          <p
                            class="pb-2 text-base font-medium text-[#0f1b0d] dark:text-gray-300"
                          >
                            Minimum Alım Miktarı
                          </p>
                          <input
                            id="productMinPurch"
                            class="form-input h-14 w-full flex-1 resize-none overflow-hidden rounded-lg border border-[#d1e7cf] bg-[#f8fcf8] p-4 text-base font-normal text-[#0f1b0d] placeholder:text-[#529a4c] focus:border-[#d1e7cf] focus:outline-0 focus:ring-0 dark:bg-background-dark/50 dark:border-primary/30 dark:text-white dark:placeholder:text-primary/50"
                            placeholder="Örn: 5"
                            type="number"
                            step="0.01"
                            min="0"
                          />
                        </label>
                        <p class="mt-2 text-xs text-text-secondary">
                          Tedarikçiden tek seferde yapılabilecek en az alış
                          miktarı.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex items-center justify-end gap-4 pt-4">
              <a
                href="/product/track"
                class="flex h-12 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-100 px-5 text-base font-bold text-text-primary hover:bg-gray-200"
              >
                İptal
              </a>
              <button
                id="updateProductBtn"
                type="button"
                class="flex h-12 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-5 text-base font-bold text-white hover:bg-primary/90"
              >
                Değişiklikleri Kaydet
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      let selectedIngredients = [];
      let allIngredients = [];
      let productId = null;
      let productTypes = [];
      let allWholesalers = [];
      let removeImageRequested = false;
      let globalSettings = {};

      // Ayarları yükle
      async function loadSettings() {
        try {
          const response = await fetch("/api/settings");
          const settings = await response.json();
          settings.forEach(s => {
            globalSettings[s.code] = parseFloat(s.value);
          });
          // Mevcut fiyat için hesapla
          const price = parseFloat(document.getElementById("productPrice").value) || 0;
          if (price > 0) updateTaxDisplay(price);
        } catch (error) {
          console.error("Settings load error:", error);
        }
      }

      function updateTaxDisplay(price) {
        const infoDiv = document.getElementById("taxInfoDisplay");
        if (!infoDiv) return;

        if (price > 0 && (globalSettings.KDV_FOOD !== undefined || globalSettings.KDV_DRINK !== undefined)) {
          const kdvFood = globalSettings.KDV_FOOD || 10;
          const kdvDrink = globalSettings.KDV_DRINK || 20;
          
          const taxFood = (price * kdvFood / (100 + kdvFood)).toFixed(2);
          const netFood = (price - taxFood).toFixed(2);
          
          const taxDrink = (price * kdvDrink / (100 + kdvDrink)).toFixed(2);
          const netDrink = (price - taxDrink).toFixed(2);
          
          infoDiv.innerHTML = `
            <div class="flex flex-col gap-1">
              <span class="font-medium text-[#529a4c]">KDV Dahil (Yiyecek %${kdvFood}): Net ${netFood} + KDV ${taxFood} TL</span>
              <span class="font-medium text-[#529a4c]">KDV Dahil (İçecek %${kdvDrink}): Net ${netDrink} + KDV ${taxDrink} TL</span>
            </div>
          `;
          infoDiv.classList.remove("hidden");
        } else {
          infoDiv.classList.add("hidden");
        }
      }

      // Fiyat değişince güncelle
      document.getElementById("productPrice").addEventListener("input", (e) => {
        updateTaxDisplay(parseFloat(e.target.value) || 0);
      });

      // Yetki kontrolü
      (function guardAdmin() {
        loadSettings();
        const userType = localStorage.getItem("userType");
        if (!userType) {
          window.location.href = "/";
          return;
        }
        if (userType === "kasa") {
          window.location.href = "/cashier";
        }
      })();

      // URL'den ürün ID'sini al
      function getProductId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id");
      }

      // Ürün tiplerini yükle
      async function loadProductTypes() {
        try {
          const response = await fetch("/api/products/types/list");
          productTypes = await response.json();

          const select = document.getElementById("productType");
          select.innerHTML = '<option value="">Ürün tipi seçin...</option>';

          productTypes.forEach((type) => {
            const option = document.createElement("option");
            option.value = type.id;
            option.textContent = type.type_name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Load product types error:", error);
        }
      }

      // Ürün bilgilerini yükle
      async function loadProduct() {
        productId = getProductId();
        if (!productId) {
          alert("Ürün ID bulunamadı");
          window.location.href = "/product/track";
          return;
        }

        try {
          const [productResponse, recipeResponse] = await Promise.all([
            fetch(`/api/products/${productId}`),
            fetch(`/api/products/${productId}/recipe`).catch(() => null),
          ]);

          if (!productResponse.ok) {
            alert("Ürün bulunamadı");
            window.location.href = "/product/track";
            return;
          }

          const product = await productResponse.json();
          const recipe =
            recipeResponse && recipeResponse.ok
              ? await recipeResponse.json()
              : [];

          // Form alanlarını doldur
          document.getElementById("productName").value = product.name || "";
          document.getElementById("productPrice").value = product.price || "";
          document.getElementById("productType").value =
            product.product_type || "";
          document.getElementById("processType").value =
            product.process_type || "üretilen";

          // Process type'a göre bölümleri göster/gizle
          handleProcessTypeChange();

          // Görseli göster
          const productImageTag = document.getElementById("productImageTag");
          const noImagePlaceholder =
            document.getElementById("noImagePlaceholder");
          const productImageInput =
            document.getElementById("productImageInput");
          const chooseImageBtn = document.getElementById("chooseImageBtn");
          const removeImageBtn = document.getElementById("removeImageBtn");

          if (product.image) {
            const imagePath = product.image.replace(
              "/uploads/products/",
              "/uploads/product/"
            );
            productImageTag.src = imagePath;
            productImageTag.classList.remove("hidden");
            noImagePlaceholder.classList.add("hidden");
            productImageTag.onerror = function () {
              productImageTag.classList.add("hidden");
              noImagePlaceholder.classList.remove("hidden");
            };
            removeImageRequested = false;
          } else {
            productImageTag.src = "";
            productImageTag.classList.add("hidden");
            noImagePlaceholder.classList.remove("hidden");
            removeImageRequested = false;
          }

          // Görsel seçme ve önizleme davranışlarını ayarla
          chooseImageBtn.addEventListener("click", () =>
            productImageInput.click()
          );

          productImageInput.addEventListener("change", (e) => {
            const file = productImageInput.files && productImageInput.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            productImageTag.src = url;
            productImageTag.classList.remove("hidden");
            noImagePlaceholder.classList.add("hidden");
            removeImageRequested = false;
          });

          removeImageBtn.addEventListener("click", () => {
            // Temizle ve placeholder göster
            productImageInput.value = "";
            productImageTag.src = "";
            productImageTag.classList.add("hidden");
            noImagePlaceholder.classList.remove("hidden");
            removeImageRequested = true;
          });

          // Process type'a göre verileri yükle
          if (product.process_type === "üretilen") {
            // Reçeteyi yükle
            selectedIngredients = Array.isArray(recipe)
              ? recipe.map((item) => ({
                  ingredient_id: item.ingredient_id,
                  quantity: parseFloat(item.quantity),
                  name: item.ingredient_name,
                  unit: item.unit,
                  unit_price: parseFloat(item.unit_price || 0),
                }))
              : [];
            renderIngredientsList();
            updateTotalCost();
          } else if (product.process_type === "al-sat") {
            // Stok bilgilerini yükle (product API'den gelen stock bilgileri)
            document.getElementById("productStock").value = product.stock || 0;
            document.getElementById("productMinStock").value =
              product.min_stock || 0;
            document.getElementById("productWholesaler").value =
              product.wholesaler_id || "";
            document.getElementById("productUnitPrice").value =
              product.stock_unit_price || 0;
            document.getElementById("productMinPurch").value =
              product.min_purch || 0;
          }
        } catch (error) {
          console.error("Load product error:", error);
          alert("Ürün bilgileri yüklenirken bir hata oluştu");
        }
      }

      // Process type değiştiğinde bölümleri göster/gizle
      function handleProcessTypeChange() {
        const processType = document.getElementById("processType").value;
        const recipeSection = document.getElementById("recipeSection");
        const stockInfoSection = document.getElementById("stockInfoSection");

        if (processType === "al-sat") {
          recipeSection.classList.add("hidden");
          stockInfoSection.classList.remove("hidden");
        } else {
          recipeSection.classList.remove("hidden");
          stockInfoSection.classList.add("hidden");
        }
      }

      // Tedarikçileri yükle
      async function loadWholesalers() {
        try {
          const response = await fetch("/api/stock/wholesalers");
          allWholesalers = await response.json();

          const select = document.getElementById("productWholesaler");
          select.innerHTML =
            '<option value="">Tedarikçi seçin (Opsiyonel)</option>';

          allWholesalers.forEach((wholesaler) => {
            const option = document.createElement("option");
            option.value = wholesaler.id;
            option.textContent = wholesaler.name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Load wholesalers error:", error);
        }
      }

      // Malzemeleri yükle
      async function loadIngredients() {
        try {
          const response = await fetch("/api/stock/ingredients");
          allIngredients = await response.json();

          const select = document.getElementById("ingredientSelect");
          select.innerHTML = '<option value="">Malzeme seçin...</option>';

          allIngredients.forEach((ing) => {
            const option = document.createElement("option");
            option.value = ing.id;
            const priceText = ing.unit_price
              ? ` - ₺${parseFloat(ing.unit_price).toFixed(2)}/${ing.unit}`
              : "";
            option.textContent = `${ing.name} (${ing.unit})${priceText}`;
            option.dataset.unit = ing.unit;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Load ingredients error:", error);
        }
      }

      // Malzeme ekle
      document
        .getElementById("addIngredientBtn")
        .addEventListener("click", () => {
          const select = document.getElementById("ingredientSelect");
          const quantityInput = document.getElementById("ingredientQuantity");

          const ingredientId = select.value;
          const quantity = parseFloat(quantityInput.value);

          if (!ingredientId || !quantity || quantity <= 0) {
            alert("Lütfen malzeme seçin ve miktar girin");
            return;
          }

          const ingredient = allIngredients.find(
            (ing) => ing.id == ingredientId
          );
          if (!ingredient) return;

          // Zaten eklenmiş mi kontrol et
          if (
            selectedIngredients.find(
              (item) => item.ingredient_id == ingredientId
            )
          ) {
            alert("Bu malzeme zaten eklenmiş");
            return;
          }

          selectedIngredients.push({
            ingredient_id: parseInt(ingredientId),
            quantity: quantity,
            name: ingredient.name,
            unit: ingredient.unit,
            unit_price: parseFloat(ingredient.unit_price || 0),
          });

          renderIngredientsList();
          updateTotalCost();

          // Formu temizle
          select.value = "";
          quantityInput.value = "";
        });

      // Malzeme listesini render et
      function renderIngredientsList() {
        const container = document.getElementById("ingredientsList");

        if (selectedIngredients.length === 0) {
          container.innerHTML =
            '<p class="text-center text-sm text-[#529a4c] dark:text-primary/70 py-4">Henüz malzeme eklenmedi</p>';
          return;
        }

        container.innerHTML = "";
        selectedIngredients.forEach((item, index) => {
          const div = document.createElement("div");
          div.className =
            "flex items-center justify-between rounded-lg bg-background-light p-4 dark:bg-background-dark/50";
          div.innerHTML = `
            <p class="font-medium text-[#0f1b0d] dark:text-white">
              ${item.name}
            </p>
            <div class="flex items-center gap-4">
              <p class="text-[#529a4c] dark:text-primary/80">
                ${item.quantity} ${item.unit}
              </p>
              <button
                type="button"
                class="text-gray-400 hover:text-red-500 dark:hover:text-red-400"
                onclick="removeIngredient(${index})"
              >
                <span class="material-symbols-outlined text-xl">delete</span>
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      }

      // Malzeme kaldır
      function removeIngredient(index) {
        selectedIngredients.splice(index, 1);
        renderIngredientsList();
        updateTotalCost();
      }

      // Toplam maliyeti güncelle
      function updateTotalCost() {
        let total = 0;
        selectedIngredients.forEach((item) => {
          const unitPrice = item.unit_price || 0;
          total += item.quantity * unitPrice;
        });

        document.getElementById("totalCost").textContent = `₺${total.toFixed(
          2
        )}`;
      }

      // Ürünü güncelle
      document
        .getElementById("updateProductBtn")
        .addEventListener("click", async () => {
          const name = document.getElementById("productName").value.trim();
          const price = parseFloat(
            document.getElementById("productPrice").value
          );
          const productType = document.getElementById("productType").value;

          if (!name || !price || price <= 0) {
            alert("Lütfen ürün adı ve geçerli bir fiyat girin");
            return;
          }

          if (!productType) {
            alert("Lütfen kategori seçin");
            return;
          }

          const processType = document.getElementById("processType").value;

          // Üretilen ürünler için malzeme kontrolü
          if (processType === "üretilen" && selectedIngredients.length === 0) {
            alert("Üretilen ürünler için lütfen en az bir malzeme ekleyin");
            return;
          }

          // al-sat ürünler için birim fiyat kontrolü
          if (processType === "al-sat") {
            const unitPrice =
              parseFloat(document.getElementById("productUnitPrice").value) ||
              0;
            if (unitPrice <= 0) {
              alert("al-sat ürünler için birim fiyatı 0'dan büyük olmalıdır");
              return;
            }
          }

          try {
            // FormData kullanarak resim ve diğer verileri gönder
            const formData = new FormData();
            formData.append("name", name);
            formData.append("price", price);
            formData.append("process_type", processType);
            formData.append("product_type", parseInt(productType));

            // Üretilen ürünler için reçete ekle
            if (processType === "üretilen") {
              const recipe = selectedIngredients.map((item) => ({
                ingredient_id: item.ingredient_id,
                quantity: item.quantity,
              }));
              formData.append("recipe", JSON.stringify(recipe));
            }

            // al-sat ürünler için stok bilgileri ekle
            if (processType === "al-sat") {
              formData.append(
                "stock",
                parseFloat(document.getElementById("productStock").value) || 0
              );
              formData.append(
                "min_stock",
                parseFloat(document.getElementById("productMinStock").value) ||
                  0
              );
              formData.append(
                "wholesaler_id",
                document.getElementById("productWholesaler").value || ""
              );
              formData.append(
                "unit_price",
                parseFloat(document.getElementById("productUnitPrice").value) ||
                  0
              );
              formData.append(
                "min_purch",
                parseFloat(document.getElementById("productMinPurch").value) ||
                  0
              );
            }

            // Eğer yeni bir görsel seçildiyse FormData'ya ekle; aksi halde kaldırma isteğini ekle
            const fileInput = document.getElementById("productImageInput");
            if (fileInput && fileInput.files && fileInput.files[0]) {
              formData.append("image", fileInput.files[0]);
            } else if (removeImageRequested) {
              formData.append("remove_image", "1");
            }

            // Ürünü güncelle
            const updateResponse = await fetch(`/api/products/${productId}`, {
              method: "PUT",
              body: formData,
            });

            if (!updateResponse.ok) {
              const data = await updateResponse.json();
              alert(data.error || "Ürün güncellenirken bir hata oluştu");
              return;
            }

            alert("Ürün başarıyla güncellendi!");
            window.location.href = "/product/track";
          } catch (error) {
            console.error("Update product error:", error);
            alert("Bir hata oluştu");
          }
        });

      // Process type değişikliğini dinle
      document
        .getElementById("processType")
        .addEventListener("change", handleProcessTypeChange);

      // Sayfa yüklendiğinde
      async function init() {
        await Promise.all([
          loadProductTypes(),
          loadIngredients(),
          loadWholesalers(),
        ]);
        await loadProduct();
      }

      init();
    </script>
    <script src="/components/sidebar.js"></script>
  </body>
</html>
